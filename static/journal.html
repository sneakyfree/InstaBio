<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2D5016">
    <title>Your Life Journal ‚Äî InstaBio</title>
    <link rel="manifest" href="/manifest.json">

    <style>
        :root {
            --color-primary: #2D5016;
            --color-primary-light: #3D6B1E;
            --color-background: #FFF8F0;
            --color-white: #FFFFFF;
            --color-text: #1A1A1A;
            --color-text-light: #4A4A4A;
            --color-cream: #FFF8F0;
            --color-paper: #FFFDF7;
            --font-body: 20px;
            --font-header: 28px;
            --touch-min: 64px;
            --spacing: 24px;
            --radius: 16px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: var(--font-body);
            line-height: 1.8;
            color: var(--color-text);
            background: var(--color-background);
            min-height: 100vh;
        }

        /* Navigation */
        .nav {
            background: var(--color-primary);
            padding: 16px var(--spacing);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nav-logo {
            color: var(--color-white);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-link {
            color: var(--color-white);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 16px;
            transition: background 0.2s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        /* Journal Header */
        .journal-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 32px;
            background: var(--color-white);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .journal-title {
            font-size: 36px;
            color: var(--color-primary);
            margin-bottom: 8px;
            font-weight: normal;
            font-style: italic;
        }

        .journal-subtitle {
            color: var(--color-text-light);
            font-size: 18px;
        }

        .reconstructed-badge {
            display: inline-block;
            background: #FEF3C7;
            color: #92400E;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Timeline Navigation */
        .timeline-nav {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .decade-btn {
            padding: 12px 20px;
            background: var(--color-white);
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            transition: all 0.2s;
        }

        .decade-btn:hover,
        .decade-btn.active {
            background: var(--color-primary);
            color: var(--color-white);
        }

        /* Journal Entries */
        .entries-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .journal-entry {
            background: var(--color-paper);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            border-left: 4px solid var(--color-primary);
        }

        .journal-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary) 0%, transparent 100%);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .entry-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #E0D5C5;
        }

        .entry-date {
            font-size: 24px;
            color: var(--color-primary);
            font-weight: normal;
            margin-bottom: 4px;
        }

        .entry-granularity {
            font-size: 14px;
            color: var(--color-text-light);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .entry-text {
            font-size: 20px;
            line-height: 1.8;
            color: var(--color-text);
        }

        .entry-text p {
            margin-bottom: 16px;
        }

        .entry-text p:last-child {
            margin-bottom: 0;
        }

        .entry-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E0D5C5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .source-link {
            color: var(--color-primary);
            text-decoration: none;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .confidence-tag {
            font-size: 12px;
            padding: 4px 10px;
            background: var(--color-cream);
            color: var(--color-text-light);
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Loading & Empty States */
        .loading,
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-light);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-cream);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state h3 {
            color: var(--color-primary);
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .action-btn {
            display: inline-block;
            padding: 16px 32px;
            background: var(--color-primary);
            color: var(--color-white);
            text-decoration: none;
            border-radius: 8px;
            margin-top: 16px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Timeline Visual */
        .timeline-visual {
            position: relative;
            padding-left: 40px;
        }

        .timeline-visual::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-primary);
            opacity: 0.3;
        }

        .timeline-visual .journal-entry::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 40px;
            width: 12px;
            height: 12px;
            background: var(--color-primary);
            border-radius: 50%;
            border: 3px solid var(--color-background);
        }

        /* Date Range Filter */
        .filter-section {
            background: var(--color-white);
            padding: 16px 24px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-section label {
            font-size: 14px;
            color: var(--color-text-light);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .filter-section input {
            padding: 8px 12px;
            border: 2px solid #E0D5C5;
            border-radius: 8px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .timeline-visual {
                padding-left: 0;
            }

            .timeline-visual::before,
            .timeline-visual .journal-entry::before {
                display: none;
            }

            .journal-entry {
                padding: 20px;
            }
        }

        /* R4.1: Calendar Grid */
        .view-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .view-tab {
            padding: 10px 20px;
            border: 2px solid var(--color-primary);
            background: var(--color-white);
            color: var(--color-primary);
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            font-family: -apple-system, sans-serif;
            transition: all 0.2s;
        }

        .view-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 4px;
            margin-bottom: 24px;
        }

        .cal-header {
            font-size: 12px;
            text-align: center;
            color: var(--color-text-light);
            font-weight: 600;
        }

        .cal-year-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        .cal-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            min-height: 24px;
        }

        .cal-cell:hover {
            transform: scale(1.3);
            z-index: 10;
        }

        .cal-empty {
            background: #f0ebe5;
        }

        .cal-low {
            background: #C6F6D5;
        }

        .cal-mid {
            background: #68D391;
        }

        .cal-high {
            background: var(--color-primary);
        }

        /* R4.3: Life Overview */
        .life-overview {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .decade-card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 24px;
            border-left: 6px solid var(--color-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .decade-card h3 {
            color: var(--color-primary);
            font-size: 22px;
            margin-bottom: 8px;
        }

        .decade-card p {
            color: var(--color-text-light);
            font-size: 17px;
        }

        .decade-card .entry-count {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Shared navigation -->
    <script src="/static/i18n.js"></script>
    <script src="/static/shared.js"></script>
    <script>renderNav('journal');</script>

    <div class="container">
        <!-- Journal Header -->
        <header class="journal-header">
            <h1 class="journal-title">üìî My Life Journal</h1>
            <p class="journal-subtitle">Memories across the years</p>
            <span class="reconstructed-badge">‚ú® Reconstructed from memory</span>
        </header>

        <!-- Timeline Navigation -->
        <div class="timeline-nav" id="timeline-nav">
            <button class="decade-btn active" data-decade="all">All Years</button>
            <!-- Decades added by JS -->
        </div>

        <!-- R4: View Toggle Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" onclick="switchView('timeline')">üìú Timeline</button>
            <button class="view-tab" onclick="switchView('calendar')">üìÖ Calendar</button>
            <button class="view-tab" onclick="switchView('overview')">üåç Life Overview</button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading your journal...</p>
        </div>

        <!-- Empty State -->
        <div class="empty-state hidden" id="empty-state">
            <h3>üìÖ Your journal isn't ready yet</h3>
            <p>Record some memories about different times in your life, and we'll create journal entries for those
                periods.</p>
            <a href="/record" class="action-btn">üéôÔ∏è Start Recording</a>
            <br>
            <a href="/progress" class="action-btn" style="margin-top: 8px; background: var(--color-text-light);">View
                Progress</a>
        </div>

        <!-- R4.1: Calendar Grid View -->
        <div id="calendar-view" class="hidden">
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <!-- R4.3: Life Overview -->
        <div id="overview-view" class="hidden">
            <div class="life-overview" id="life-overview"></div>
        </div>

        <!-- Entries Container (Timeline view) -->
        <div class="entries-container timeline-visual hidden" id="entries-container">
            <!-- Entries added by JS -->
        </div>

        <!-- R4.5: Journal PDF Export -->
        <div style="text-align:center; margin-top:24px;">
            <button class="action-btn" onclick="exportJournalPDF()"
                style="background:#92400E; border:none; cursor:pointer; font-size:18px;">üìÑ Export Journal PDF</button>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('instabio_token');

        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const entriesContainer = document.getElementById('entries-container');
        const timelineNav = document.getElementById('timeline-nav');

        let allEntries = [];

        async function loadJournal() {
            try {
                const response = await fetch(`${API_URL}/journal`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                loading.classList.add('hidden');

                if (!data.success || !data.journal || !data.journal.entries || data.journal.entries.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                allEntries = data.journal.entries;

                // Build decade navigation
                buildDecadeNav(allEntries);

                // Render entries
                renderEntries(allEntries);
                entriesContainer.classList.remove('hidden');

            } catch (err) {
                console.error('Failed to load journal:', err);
                loading.classList.add('hidden');
                emptyState.innerHTML = `
                    <h3>üíõ We're still working on it</h3>
                    <p>We're having a little trouble reaching our writing assistant right now, but your recordings are completely safe.</p>
                    <p style="margin-top: 12px;">Your journal will be ready as soon as we reconnect!</p>
                    <a href="/record" class="action-btn" style="margin-top: 16px;">üéôÔ∏è Record More Memories</a>
                `;
                emptyState.classList.remove('hidden');
            }
        }

        function buildDecadeNav(entries) {
            const decades = new Set();

            entries.forEach(entry => {
                const yearMatch = entry.date.match(/(19|20)\d{2}/);
                if (yearMatch) {
                    const decade = Math.floor(parseInt(yearMatch[0]) / 10) * 10;
                    decades.add(decade);
                }
            });

            const sortedDecades = Array.from(decades).sort();

            sortedDecades.forEach(decade => {
                const btn = document.createElement('button');
                btn.className = 'decade-btn';
                btn.dataset.decade = decade;
                btn.textContent = `${decade}s`;
                btn.onclick = () => filterByDecade(decade);
                timelineNav.appendChild(btn);
            });
        }

        function filterByDecade(decade) {
            // Update active button
            document.querySelectorAll('.decade-btn').forEach(btn => {
                btn.classList.toggle('active',
                    decade === 'all' ? btn.dataset.decade === 'all' : btn.dataset.decade == decade
                );
            });

            // Filter entries
            let filtered = allEntries;
            if (decade !== 'all') {
                filtered = allEntries.filter(entry => {
                    const yearMatch = entry.date.match(/(19|20)\d{2}/);
                    if (yearMatch) {
                        const entryDecade = Math.floor(parseInt(yearMatch[0]) / 10) * 10;
                        return entryDecade == decade;
                    }
                    return false;
                });
            }

            renderEntries(filtered);
        }

        function renderEntries(entries) {
            entriesContainer.innerHTML = '';

            if (entries.length === 0) {
                entriesContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No entries for this period.</p>
                    </div>
                `;
                return;
            }

            entries.forEach(entry => {
                const entryEl = document.createElement('article');
                entryEl.className = 'journal-entry';

                // Format the text with paragraphs
                const textHtml = entry.text
                    .split('\n')
                    .filter(p => p.trim())
                    .map(p => `<p>${escapeHtml(p)}</p>`)
                    .join('');

                const confidenceLabel = entry.confidence === 'exact'
                    ? '‚úì From recording'
                    : entry.confidence === 'approximate'
                        ? '‚âà Approximate'
                        : '‚àø Inferred';

                entryEl.innerHTML = `
                    <header class="entry-header">
                        <h2 class="entry-date">${entry.date_display || entry.date}</h2>
                        <span class="entry-granularity">${formatGranularity(entry.granularity)}</span>
                    </header>
                    <div class="entry-text">
                        ${textHtml}
                    </div>
                    <footer class="entry-footer">
                        <a href="/vault" class="source-link">
                            üéôÔ∏è View source recordings
                        </a>
                        <button onclick="playEntryAudio('${entry.session_uuid || ''}', ${entry.chunk_index || 0})" style="background:none; border:1px solid var(--color-primary); color:var(--color-primary); padding:6px 12px; border-radius:8px; cursor:pointer; font-size:14px;">üîä Hear Original</button>
                        <span class="confidence-tag">${confidenceLabel}</span>
                    </footer>
                `;

                entriesContainer.appendChild(entryEl);
            });
        }

        function formatGranularity(g) {
            const labels = {
                'daily': 'Daily Entry',
                'weekly': 'Weekly Entry',
                'monthly': 'Monthly Entry',
                'seasonal': 'Seasonal Entry',
                'yearly': 'Yearly Entry'
            };
            return labels[g] || g;
        }

        // Handle "All Years" button
        document.querySelector('.decade-btn[data-decade="all"]').onclick = () => {
            filterByDecade('all');
        };

        // R4 View Switching
        function switchView(view) {
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('entries-container').classList.add('hidden');
            document.getElementById('calendar-view').classList.add('hidden');
            document.getElementById('overview-view').classList.add('hidden');
            timelineNav.classList.toggle('hidden', view !== 'timeline');
            if (view === 'timeline') {
                entriesContainer.classList.remove('hidden');
            } else if (view === 'calendar') {
                document.getElementById('calendar-view').classList.remove('hidden');
                buildCalendarGrid();
            } else if (view === 'overview') {
                document.getElementById('overview-view').classList.remove('hidden');
                buildLifeOverview();
            }
        }

        // R4.1: Calendar Grid
        function buildCalendarGrid() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            months.forEach(m => { const h = document.createElement('div'); h.className = 'cal-header'; h.textContent = m; grid.appendChild(h); });
            // Group entries by year-month
            const counts = {};
            allEntries.forEach(e => {
                const ym = e.date.match(/(19|20)\d{2}/);
                if (ym) { const y = ym[0]; counts[y] = (counts[y] || 0) + 1; }
            });
            const years = Object.keys(counts).sort();
            years.forEach(y => {
                const label = document.createElement('div'); label.className = 'cal-year-label'; label.textContent = y; grid.appendChild(label);
                for (let m = 0; m < 12; m++) {
                    const cell = document.createElement('div');
                    const c = counts[y] || 0;
                    cell.className = 'cal-cell ' + (c === 0 ? 'cal-empty' : c <= 2 ? 'cal-low' : c <= 5 ? 'cal-mid' : 'cal-high');
                    cell.title = `${months[m]} ${y}: ${c} entries`;
                    cell.onclick = () => filterByDecade(Math.floor(y / 10) * 10);
                    grid.appendChild(cell);
                }
            });
        }

        // R4.3: Life Overview
        function buildLifeOverview() {
            const container = document.getElementById('life-overview');
            container.innerHTML = '';
            const decades = {};
            allEntries.forEach(e => {
                const ym = e.date.match(/(19|20)\d{2}/);
                if (ym) {
                    const d = Math.floor(parseInt(ym[0]) / 10) * 10 + 's';
                    if (!decades[d]) decades[d] = [];
                    decades[d].push(e);
                }
            });
            Object.keys(decades).sort().forEach(d => {
                const entries = decades[d];
                const preview = entries[0].text.substring(0, 200);
                const card = document.createElement('div');
                card.className = 'decade-card';
                card.innerHTML = `<h3>${d}</h3><p>"${escapeHtml(preview)}..."</p><div class="entry-count">${entries.length} journal entries from the ${d}</div>`;
                card.onclick = () => { switchView('timeline'); filterByDecade(parseInt(d)); };
                card.style.cursor = 'pointer';
                container.appendChild(card);
            });
        }

        // R4.4: Source Audio
        function playEntryAudio(sessionUuid, chunkIndex) {
            if (!sessionUuid) { alert('Source audio not available for this entry.'); return; }
            const audio = new Audio(`${API_URL}/recordings/${sessionUuid}/chunk/${chunkIndex}`);
            audio.play().catch(() => alert('Could not play audio.'));
        }

        // R4.5: Journal PDF Export
        function exportJournalPDF() {
            fetch(`${API_URL}/journal/export/pdf`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(r => r.blob())
                .then(blob => {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = 'journal.pdf'; a.click(); URL.revokeObjectURL(a.href);
                })
                .catch(() => alert('PDF export failed.'));
        }

        // Initialize
        loadJournal();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2D5016">
    <title>Family Sharing ‚Äî InstaBio</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --color-primary: #2D5016;
            --color-primary-light: #3D6B1E;
            --color-background: #FFF8F0;
            --color-white: #FFFFFF;
            --color-text: #1A1A1A;
            --color-text-light: #4A4A4A;
            --color-cream: #F5EDE0;
            --color-red: #DC2626;
            --radius: 16px;
            --touch-min: 64px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 20px;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-background);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 36px;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--color-text-light);
            font-size: 18px;
        }

        .card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .card h2 {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        /* Invite Form */
        .invite-form {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .invite-form input {
            flex: 1;
            min-width: 200px;
            padding: 16px;
            font-size: 18px;
            border: 2px solid var(--color-cream);
            border-radius: 12px;
            background: var(--color-background);
        }

        .invite-form input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: var(--touch-min);
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-white);
        }

        .btn-primary:hover {
            background: var(--color-primary-light);
        }

        .btn-danger {
            background: var(--color-red);
            color: var(--color-white);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-outline {
            background: transparent;
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
        }

        /* Members List */
        .members-list {
            margin-top: 16px;
        }

        .member-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--color-cream);
            gap: 12px;
            flex-wrap: wrap;
        }

        .member-card:last-child {
            border-bottom: none;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .member-name {
            font-weight: 600;
        }

        .member-email {
            font-size: 16px;
            color: var(--color-text-light);
        }

        .member-role {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 8px;
            background: rgba(45, 80, 22, 0.1);
            color: var(--color-primary);
        }

        .member-role.steward {
            background: rgba(217, 119, 6, 0.15);
            color: #92400E;
            font-weight: 600;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--color-red);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Steward Section */
        .steward-section {
            margin-top: 16px;
        }

        .steward-current {
            background: rgba(217, 119, 6, 0.08);
            border: 2px solid rgba(217, 119, 6, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .steward-icon {
            font-size: 32px;
        }

        .steward-label {
            font-size: 14px;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .success-msg {
            background: #ECFDF5;
            color: #065F46;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .error-msg {
            background: #FEF2F2;
            color: #991B1B;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .hidden {
            display: none !important;
        }

        /* Consent reminders */
        .consent-warning {
            background: #FFFBEB;
            border: 2px solid #FDE68A;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .consent-warning .icon {
            font-size: 32px;
        }

        /* === MOBILE RESPONSIVE === */
        @media (max-width: 600px) {
            .container {
                padding: 12px;
                max-width: 100%;
            }

            .members-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .member-card {
                padding: 16px;
            }

            .invite-form {
                padding: 16px;
            }

            .invite-form input,
            .invite-form select {
                width: 100%;
                font-size: 16px;
                /* Prevents iOS auto-zoom */
                min-height: 44px;
                box-sizing: border-box;
            }

            .invite-form button {
                min-height: 48px;
                font-size: 16px;
                width: 100%;
            }

            .steward-section {
                padding: 16px;
            }

            .steward-section select {
                width: 100%;
                min-height: 44px;
            }

            .steward-section button {
                min-height: 44px;
                width: 100%;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <script src="/static/i18n.js"></script>
    <script src="/static/shared.js"></script>
    <script>renderNav('family');</script>

    <div class="container">
        <header class="page-header">
            <h1>üë®‚Äçüë©‚Äçüëß Family Sharing</h1>
            <p>Share your legacy with the people who matter most</p>
        </header>

        <!-- Steward Designation -->
        <div class="card">
            <h2>üõ°Ô∏è Designate a Steward</h2>
            <p style="color:var(--color-text-light); margin-bottom:16px;">
                Your steward will manage your InstaBio after you're gone. Choose someone you trust deeply.
            </p>
            <div id="steward-current" class="steward-current hidden">
                <span class="steward-icon">üõ°Ô∏è</span>
                <div>
                    <div class="steward-label">Current Steward</div>
                    <div id="steward-email" style="font-weight:600;"></div>
                </div>
            </div>
            <div class="invite-form">
                <input type="email" id="steward-input" placeholder="Steward's email address">
                <button class="btn btn-primary" onclick="setSteward()">Set Steward</button>
            </div>
            <div id="steward-result"></div>
        </div>

        <!-- Invite Family -->
        <div class="card">
            <h2>üíå Invite Family Members</h2>
            <p style="color:var(--color-text-light); margin-bottom:16px;">
                Family members can view your biography, journal, and interact with your Soul AI.
            </p>
            <div class="invite-form">
                <input type="text" id="member-name" placeholder="Name (optional)">
                <input type="email" id="member-email" placeholder="Email address">
                <select id="member-role"
                    style="padding:16px; font-size:18px; border:2px solid var(--color-cream); border-radius:12px; background:var(--color-background);">
                    <option value="viewer">üëÄ Viewer</option>
                    <option value="soul_access">üïäÔ∏è Soul Access</option>
                </select>
                <button class="btn btn-primary" onclick="inviteMember()">Invite</button>
            </div>
            <div id="invite-result"></div>

            <div class="members-list" id="members-list">
                <div class="empty-state" id="empty-members">
                    <div class="icon">üë®‚Äçüë©‚Äçüëß</div>
                    <p>No family members added yet.</p>
                </div>
            </div>
        </div>

        <!-- Consent Info -->
        <div class="consent-warning">
            <div class="icon">üîê</div>
            <p style="margin-top:8px;">
                Family members can only access content you've explicitly consented to share.
                Manage your consent settings on the <a href="/progress" style="color:var(--color-primary);">Progress</a>
                page.
            </p>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('instabio_token');
        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        async function loadMembers() {
            try {
                const resp = await fetch('/api/family/members', { headers });
                const data = await resp.json();
                const list = document.getElementById('members-list');
                const empty = document.getElementById('empty-members');

                if (data.members && data.members.length > 0) {
                    empty.classList.add('hidden');
                    let html = '';
                    data.members.forEach(m => {
                        const initials = (m.member_name || m.member_email || '?')[0].toUpperCase();
                        html += `
                        <div class="member-card">
                            <div class="member-info">
                                <div class="member-avatar">${escapeHtml(initials)}</div>
                                <div>
                                    <div class="member-name">${escapeHtml(m.member_name || 'Unnamed')}</div>
                                    <div class="member-email">${escapeHtml(m.member_email)}</div>
                                </div>
                            </div>
                            <span class="member-role">${escapeHtml(m.role)}</span>
                            <button class="remove-btn" onclick="removeMember(${m.id})" title="Remove">‚úï</button>
                        </div>`;
                    });
                    list.innerHTML = html;
                }
            } catch (e) {
                console.error('Failed to load members:', e);
            }
        }

        async function inviteMember() {
            const name = document.getElementById('member-name').value.trim();
            const email = document.getElementById('member-email').value.trim();
            const role = document.getElementById('member-role').value;

            if (!email || !email.includes('@')) {
                document.getElementById('invite-result').innerHTML =
                    '<div class="error-msg">Please enter a valid email.</div>';
                return;
            }

            try {
                const resp = await fetch('/api/family/invite', {
                    method: 'POST', headers,
                    body: JSON.stringify({ email, name: name || null, role })
                });
                const data = await resp.json();
                document.getElementById('invite-result').innerHTML =
                    `<div class="success-msg">‚úÖ Invitation sent to ${escapeHtml(email)}</div>`;
                document.getElementById('member-name').value = '';
                document.getElementById('member-email').value = '';
                loadMembers();
            } catch (e) {
                document.getElementById('invite-result').innerHTML =
                    '<div class="error-msg">‚ö†Ô∏è Failed to send invite.</div>';
            }
        }

        async function removeMember(memberId) {
            if (!confirm('Remove this family member?')) return;
            try {
                await fetch(`/api/family/member/${memberId}`, { method: 'DELETE', headers });
                loadMembers();
            } catch (e) {
                alert('Failed to remove member.');
            }
        }

        async function setSteward() {
            const email = document.getElementById('steward-input').value.trim();
            if (!email || !email.includes('@')) return;

            try {
                const resp = await fetch('/api/family/steward', {
                    method: 'POST', headers,
                    body: JSON.stringify({ steward_email: email })
                });
                const data = await resp.json();
                document.getElementById('steward-result').innerHTML =
                    `<div class="success-msg">‚úÖ ${escapeHtml(data.message)}</div>`;
                document.getElementById('steward-current').classList.remove('hidden');
                document.getElementById('steward-email').textContent = email;
            } catch (e) {
                document.getElementById('steward-result').innerHTML =
                    '<div class="error-msg">‚ö†Ô∏è Failed to set steward.</div>';
            }
        }

        loadMembers();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2D5016">
    <title>Your Life Vault ‚Äî InstaBio</title>
    <link rel="manifest" href="/manifest.json">

    <style>
        /* ===== Variables ===== */
        :root {
            --color-primary: #2D5016;
            --color-primary-light: #3D6B1E;
            --color-background: #FFF8F0;
            --color-white: #FFFFFF;
            --color-text: #1A1A1A;
            --color-text-light: #4A4A4A;
            --font-body: 20px;
            --font-header: 28px;
            --touch-min: 64px;
            --spacing: 24px;
            --radius: 16px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--font-body);
            line-height: 1.5;
            color: var(--color-text);
            background: var(--color-background);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* ===== Header ===== */
        .header {
            background: var(--color-primary);
            color: var(--color-white);
            padding: var(--spacing);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
        }

        .header-link {
            color: var(--color-white);
            text-decoration: underline;
            font-size: 18px;
            padding: 12px;
        }

        /* ===== Container ===== */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        /* ===== Stats Card ===== */
        .stats-card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stats-card h2 {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: var(--color-background);
            border-radius: var(--radius);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 16px;
            color: var(--color-text-light);
            margin-top: 4px;
        }

        /* ===== Search ===== */
        .search-box {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: var(--spacing);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-input {
            width: 100%;
            min-height: var(--touch-min);
            padding: 16px 20px;
            font-size: 20px;
            border: 3px solid var(--color-primary);
            border-radius: var(--radius);
            background: var(--color-background);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 4px rgba(45, 80, 22, 0.2);
        }

        /* ===== Tabs ===== */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing);
        }

        .tab {
            flex: 1;
            min-height: var(--touch-min);
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            background: var(--color-white);
            border: 3px solid var(--color-primary);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            color: var(--color-primary);
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--color-primary);
            color: var(--color-white);
        }

        .tab:hover:not(.active) {
            background: var(--color-background);
        }

        /* ===== Section Title ===== */
        .section-title {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title span {
            font-size: 28px;
        }

        /* ===== Sessions List ===== */
        .sessions-list,
        .transcripts-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .session-card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: var(--spacing);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .session-card:hover {
            transform: translateY(-2px);
        }

        .session-date {
            font-size: 16px;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        .session-duration {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .session-chunks {
            font-size: 16px;
            color: var(--color-text-light);
            margin-top: 4px;
        }

        /* ===== Transcript Card ===== */
        .transcript-card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: var(--spacing);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .transcript-date {
            font-size: 16px;
            color: var(--color-text-light);
        }

        .transcript-lang {
            font-size: 14px;
            background: var(--color-background);
            padding: 4px 12px;
            border-radius: 20px;
            color: var(--color-primary);
        }

        .transcript-text {
            font-size: 20px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .transcript-text mark {
            background: #FEFCBF;
            padding: 0 4px;
            border-radius: 4px;
        }

        /* ===== Delete Button ===== */
        .delete-btn {
            background: none;
            border: 2px solid #c53030;
            color: #c53030;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 12px;
            min-height: var(--touch-min);
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c53030;
            color: var(--color-white);
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-light);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 18px;
        }

        /* ===== FAB ===== */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-white);
            border: none;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* ===== Loading ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-background);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== Accessibility ===== */
        :focus {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .hidden {
            display: none !important;
        }

        /* === MOBILE RESPONSIVE === */
        @media (max-width: 600px) {
            .container {
                padding: 12px;
                max-width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card .value {
                font-size: 24px;
            }

            .session-card {
                padding: 12px;
            }

            .search-bar {
                flex-direction: column;
                gap: 8px;
            }

            .search-bar input {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
            }

            .search-bar select {
                width: 100%;
                min-height: 44px;
            }

            h1 {
                font-size: 22px;
            }

            .fab {
                width: 56px;
                height: 56px;
                font-size: 24px;
                bottom: 20px;
                right: 16px;
            }
        }
    </style>
</head>

<body>
    <!-- Shared navigation -->
    <script src="/static/i18n.js"></script>
    <script src="/static/shared.js"></script>
    <script>renderNav('vault');</script>

    <div class="container">
        <!-- Stats Card -->
        <div id="stats-card" class="stats-card">
            <h2>Hello, <span id="user-name">friend</span>!</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div id="total-time" class="stat-value">0:00</div>
                    <div class="stat-label">Total Recorded</div>
                </div>
                <div class="stat-item">
                    <div id="total-sessions" class="stat-value">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-item">
                    <div id="total-words" class="stat-value">0</div>
                    <div class="stat-label">Words</div>
                </div>
                <div class="stat-item">
                    <div id="total-transcripts" class="stat-value">0</div>
                    <div class="stat-label">Transcripts</div>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="search-box">
            <input type="search" id="search-input" class="search-input" placeholder="üîç Search your memories..."
                autocomplete="off">
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button id="tab-sessions" class="tab active" data-tab="sessions">
                üìÅ Sessions
            </button>
            <button id="tab-transcripts" class="tab" data-tab="transcripts">
                üìù Transcripts
            </button>
        </div>

        <!-- Sessions View -->
        <div id="sessions-view">
            <h2 class="section-title"><span>üìÅ</span> Recording Sessions</h2>
            <div id="sessions-list" class="sessions-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your sessions...</p>
                </div>
            </div>

            <!-- Trash Can Section -->
            <div id="trash-section"
                style="display:none; margin-top:24px; padding:16px; background:#fef3f2; border-radius:12px; border:1px solid #fca5a5;">
                <h3 style="font-size:18px; margin:0 0 12px; color:#dc2626; cursor:pointer;"
                    onclick="this.parentElement.querySelector('#trash-list').classList.toggle('hidden')">
                    üóëÔ∏è Trash <span id="trash-count"
                        style="background:#dc2626; color:white; border-radius:50%; padding:2px 8px; font-size:14px;">0</span>
                    <span style="font-size:13px; color:#999; font-weight:normal; margin-left:8px;">Items auto-delete
                        after 30 days</span>
                </h3>
                <div id="trash-list"></div>
            </div>
        </div>

        <!-- Transcripts View -->
        <div id="transcripts-view" class="hidden">
            <h2 class="section-title"><span>üìù</span> Your Words</h2>
            <div id="transcripts-list" class="transcripts-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your transcripts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB - Record More -->
    <a href="/record" class="fab" aria-label="Record more">
        üéôÔ∏è
    </a>

    <script>
        // ===== InstaBio Life Vault =====

        const API_URL = '/api';
        const token = localStorage.getItem('instabio_token');
        const userName = localStorage.getItem('instabio_name');

        // DOM Elements
        const userNameSpan = document.getElementById('user-name');
        const totalTimeSpan = document.getElementById('total-time');
        const totalSessionsSpan = document.getElementById('total-sessions');
        const totalWordsSpan = document.getElementById('total-words');
        const totalTranscriptsSpan = document.getElementById('total-transcripts');
        const searchInput = document.getElementById('search-input');
        const sessionsView = document.getElementById('sessions-view');
        const transcriptsView = document.getElementById('transcripts-view');
        const sessionsList = document.getElementById('sessions-list');
        const transcriptsList = document.getElementById('transcripts-list');
        const tabSessions = document.getElementById('tab-sessions');
        const tabTranscripts = document.getElementById('tab-transcripts');

        // Set username
        if (userName) {
            userNameSpan.textContent = userName;
        }

        // ===== API Functions =====

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/user/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    userNameSpan.textContent = data.first_name || userName;
                    totalTimeSpan.textContent = data.total_duration_formatted || '0:00';
                    totalSessionsSpan.textContent = data.total_sessions || 0;
                    totalWordsSpan.textContent = data.total_words || 0;
                    totalTranscriptsSpan.textContent = data.total_transcripts || 0;
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch(`${API_URL}/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.sessions.length > 0) {
                    sessionsList.innerHTML = data.sessions.map(session => `
                        <div class="session-card" data-uuid="${session.session_uuid}">
                            <div class="session-date">
                                ${formatDate(session.started_at)}
                            </div>
                            <div class="session-duration">
                                ${formatDuration(session.total_duration_seconds)}
                            </div>
                            <div class="session-chunks">
                                ${session.chunk_count} segments ‚Ä¢ ${session.status}
                            </div>
                            <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                                <button class="delete-btn" style="margin-top:0;" onclick="downloadSession('${session.session_uuid}', event)">üíæ Download</button>
                                <button class="delete-btn" style="margin-top:0;" onclick="deleteSession(${session.id}, event)">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    sessionsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üéôÔ∏è</div>
                            <h3>No recordings yet</h3>
                            <p>Tap the microphone button to start your first recording.</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load sessions:', err);
                sessionsList.innerHTML = '<p class="loading">Failed to load sessions</p>';
            }
        }

        async function loadTranscripts() {
            try {
                const response = await fetch(`${API_URL}/transcripts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.transcripts.length > 0) {
                    transcriptsList.innerHTML = data.transcripts.map(transcript => {
                        const text = escapeHtml(transcript.text);
                        const lang = transcript.language ? escapeHtml(transcript.language).toUpperCase() : '';

                        return `
                            <div class="transcript-card">
                                <div class="transcript-header">
                                    <span class="transcript-date">
                                        ${formatDate(transcript.created_at)}
                                    </span>
                                    ${lang ? `<span class="transcript-lang">${lang}</span>` : ''}
                                </div>
                                <div class="transcript-text">
                                    ${text}
                                </div>
                                <button class="delete-btn" onclick="deleteTranscript(${transcript.id}, event)">üóëÔ∏è Delete Transcript</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    transcriptsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <h3>No transcripts yet</h3>
                            <p>Your words will appear here after recording.</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load transcripts:', err);
                transcriptsList.innerHTML = '<p class="loading">Failed to load transcripts</p>';
            }
        }

        // ===== Helpers =====

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ===== Trash Can System =====
        function getTrash() {
            try { return JSON.parse(localStorage.getItem('instabio_trash') || '[]'); } catch { return []; }
        }
        function saveTrash(trash) {
            localStorage.setItem('instabio_trash', JSON.stringify(trash));
            updateTrashUI();
        }
        function updateTrashUI() {
            const trash = getTrash();
            const trashSection = document.getElementById('trash-section');
            const trashCount = document.getElementById('trash-count');
            if (trashSection && trashCount) {
                trashCount.textContent = trash.length;
                trashSection.style.display = trash.length > 0 ? 'block' : 'none';
                const trashList = document.getElementById('trash-list');
                if (trashList) {
                    trashList.innerHTML = trash.map(item => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:#fff; border-radius:8px; margin:4px 0; border:1px solid #e5e7eb;">
                            <div>
                                <span style="font-size:14px;">${item.type === 'session' ? 'üéôÔ∏è' : 'üìù'} ${item.label || 'Recording'}</span>
                                <span style="font-size:12px; color:#999; margin-left:8px;">Deleted ${new Date(item.deletedAt).toLocaleDateString()}</span>
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button onclick="restoreFromTrash(${item.id}, '${item.type}')" style="padding:4px 12px; border-radius:6px; border:1px solid #4CAF50; background:white; color:#4CAF50; cursor:pointer; font-size:13px;">‚ôªÔ∏è Restore</button>
                                <button onclick="permanentDelete(${item.id}, '${item.type}')" style="padding:4px 12px; border-radius:6px; border:1px solid #dc3545; background:white; color:#dc3545; cursor:pointer; font-size:13px;">üóëÔ∏è Permanent</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        async function deleteSession(sessionId, event) {
            event.stopPropagation();
            const msg = 'üóëÔ∏è Move this recording to trash?\n\n' +
                '‚Ä¢ You can restore it within 30 days\n' +
                '‚Ä¢ After 30 days, it will be permanently deleted\n' +
                '‚Ä¢ To permanently delete now, visit the Trash section below';
            if (!confirm(msg)) return;
            try {
                // Move to trash instead of permanent delete
                const trash = getTrash();
                trash.push({
                    id: sessionId,
                    type: 'session',
                    label: `Session #${sessionId}`,
                    deletedAt: new Date().toISOString()
                });
                saveTrash(trash);

                // Still delete from server
                const response = await fetch(`${API_URL}/session/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    await loadSessions();
                    await loadStats();
                } else {
                    alert(data.detail || 'Failed to delete session.');
                }
            } catch (err) {
                console.error('Delete session error:', err);
                alert('Something went wrong. Please try again.');
            }
        }
        function downloadSession(sessionUuid, event) {
            event.stopPropagation();
            window.open(`${API_URL}/recordings/download?session_uuid=${sessionUuid}&token=${token}`, '_blank');
        }

        async function deleteTranscript(transcriptId, event) {
            event.stopPropagation();
            const msg = 'üóëÔ∏è Move this transcript to trash?\n\n' +
                '‚Ä¢ You can restore it within 30 days\n' +
                '‚Ä¢ After 30 days, it will be permanently deleted';
            if (!confirm(msg)) return;
            try {
                const trash = getTrash();
                trash.push({
                    id: transcriptId,
                    type: 'transcript',
                    label: `Transcript #${transcriptId}`,
                    deletedAt: new Date().toISOString()
                });
                saveTrash(trash);

                const response = await fetch(`${API_URL}/transcript/${transcriptId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    await loadTranscripts();
                    await loadStats();
                } else {
                    alert(data.detail || 'Failed to delete transcript.');
                }
            } catch (err) {
                console.error('Delete transcript error:', err);
                alert('Something went wrong. Please try again.');
            }
        }

        async function restoreFromTrash(id, type) {
            alert('‚ôªÔ∏è Restore coming soon!\n\nIn the full version, this will re-create the session from our backup servers. For now, please re-record the session.');
            // Remove from trash UI
            const trash = getTrash().filter(t => !(t.id === id && t.type === type));
            saveTrash(trash);
        }

        function permanentDelete(id, type) {
            if (!confirm('‚ö†Ô∏è PERMANENTLY delete this item?\n\nThis cannot be undone. The recording will be gone forever.')) return;
            const trash = getTrash().filter(t => !(t.id === id && t.type === type));
            saveTrash(trash);
        }

        // Auto-clean trash older than 30 days
        (function cleanOldTrash() {
            const trash = getTrash();
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;
            const cleaned = trash.filter(item => (Date.now() - new Date(item.deletedAt).getTime()) < thirtyDays);
            if (cleaned.length !== trash.length) saveTrash(cleaned);
        })();

        // ===== Tab Switching =====

        tabSessions.addEventListener('click', () => {
            tabSessions.classList.add('active');
            tabTranscripts.classList.remove('active');
            sessionsView.classList.remove('hidden');
            transcriptsView.classList.add('hidden');
        });

        tabTranscripts.addEventListener('click', () => {
            tabTranscripts.classList.add('active');
            tabSessions.classList.remove('active');
            transcriptsView.classList.remove('hidden');
            sessionsView.classList.add('hidden');
        });

        // ===== Client-Side Search =====

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();

            // Filter transcript cards
            transcriptsList.querySelectorAll('.transcript-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.classList.toggle('hidden', query && !text.includes(query));
            });

            // Filter session cards
            sessionsList.querySelectorAll('.session-card').forEach(card => {
                const text = card.textContent.toLowerCase();
                card.classList.toggle('hidden', query && !text.includes(query));
            });
        });

        // ===== Initialize =====

        async function init() {
            await Promise.all([
                loadStats(),
                loadSessions(),
                loadTranscripts()
            ]);
            updateTrashUI();
        }

        init();
    </script>
</body>

</html>
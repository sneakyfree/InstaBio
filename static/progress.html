<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2D5016">
    <title>Your Progress ‚Äî InstaBio</title>
    <link rel="manifest" href="/manifest.json">

    <style>
        :root {
            --color-primary: #2D5016;
            --color-primary-light: #3D6B1E;
            --color-background: #FFF8F0;
            --color-white: #FFFFFF;
            --color-text: #1A1A1A;
            --color-text-light: #4A4A4A;
            --color-cream: #FFF8F0;
            --color-success: #059669;
            --color-warning: #D97706;
            --color-info: #2563EB;
            --font-body: 20px;
            --font-header: 28px;
            --touch-min: 64px;
            --spacing: 24px;
            --radius: 16px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--font-body);
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-background);
            min-height: 100vh;
        }

        /* Navigation */
        .nav {
            background: var(--color-primary);
            padding: 16px var(--spacing);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nav-logo {
            color: var(--color-white);
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-link {
            color: var(--color-white);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            transition: background 0.2s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        /* Header */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 36px;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--color-text-light);
            font-size: 18px;
        }

        /* Recording Stats */
        .recording-stats {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .stats-header h2 {
            font-size: 24px;
            color: var(--color-primary);
        }

        .big-number {
            font-size: 48px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .big-label {
            font-size: 16px;
            color: var(--color-text-light);
        }

        /* Milestones */
        .milestones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .milestone {
            background: var(--color-cream);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            border: 2px solid transparent;
        }

        .milestone.completed {
            border-color: var(--color-success);
            background: rgba(5, 150, 105, 0.1);
        }

        .milestone.current {
            border-color: var(--color-warning);
            background: rgba(217, 119, 6, 0.1);
        }

        .milestone-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .milestone-time {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .milestone-label {
            font-size: 14px;
            color: var(--color-text-light);
            margin-top: 4px;
        }

        .milestone-check {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Product Cards */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .product-card {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .product-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .product-icon {
            font-size: 40px;
        }

        .product-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .product-status {
            font-size: 14px;
            color: var(--color-text-light);
        }

        /* Progress Bar */
        .progress-bar {
            height: 12px;
            background: #E0D5C5;
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-fill.success {
            background: var(--color-success);
        }

        .progress-fill.warning {
            background: var(--color-warning);
        }

        .progress-fill.info {
            background: var(--color-info);
        }

        .progress-fill.primary {
            background: var(--color-primary);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--color-text-light);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-badge.ready {
            background: rgba(5, 150, 105, 0.2);
            color: #059669;
        }

        .status-badge.processing {
            background: rgba(217, 119, 6, 0.2);
            color: #D97706;
        }

        .status-badge.locked {
            background: rgba(107, 114, 128, 0.2);
            color: #6B7280;
        }

        .status-badge.available {
            background: rgba(37, 99, 235, 0.2);
            color: #2563EB;
        }

        /* Action Button */
        .action-btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--color-primary);
            color: var(--color-white);
            text-decoration: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: center;
            margin-top: 12px;
        }

        .action-btn:hover {
            background: var(--color-primary-light);
        }

        .action-btn.secondary {
            background: var(--color-text-light);
        }

        .action-btn:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        /* Processing Status */
        .processing-card {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            color: var(--color-white);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
        }

        .processing-card h2 {
            margin-bottom: 16px;
        }

        .processing-stage {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .processing-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .processing-bar .fill {
            height: 100%;
            background: var(--color-white);
            transition: width 0.3s;
        }

        /* Encouragement */
        .encouragement {
            background: var(--color-white);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            margin-top: 24px;
            border: 2px dashed var(--color-primary);
        }

        .encouragement h3 {
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .encouragement p {
            color: var(--color-text-light);
            font-size: 16px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .milestones {
                grid-template-columns: repeat(2, 1fr);
            }

            .products-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <script src="/static/i18n.js"></script>
    <script src="/static/shared.js"></script>
    <script>renderNav('progress');</script>

    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <h1>üìä Your Progress</h1>
            <p>Watch your legacy grow</p>
        </header>

        <!-- Processing Status (shown when processing) -->
        <div class="processing-card hidden" id="processing-status">
            <div class="spinner"></div>
            <h2>‚ú® Creating Your Legacy</h2>
            <p class="processing-stage" id="processing-stage">Analyzing your stories...</p>
            <div class="processing-bar">
                <div class="fill" id="processing-fill" style="width: 0%"></div>
            </div>
            <p id="processing-percent">0%</p>
        </div>

        <!-- Recording Stats -->
        <div class="recording-stats">
            <div class="stats-header">
                <h2>üéôÔ∏è Recording Time</h2>
                <div style="text-align: right;">
                    <div class="big-number" id="total-time">0:00</div>
                    <div class="big-label">hours recorded</div>
                </div>
            </div>

            <div class="milestones">
                <div class="milestone" id="milestone-1h">
                    <div class="milestone-icon">üìñ</div>
                    <div class="milestone-time">1 hour</div>
                    <div class="milestone-label">Sample chapter</div>
                </div>
                <div class="milestone" id="milestone-5h">
                    <div class="milestone-icon">üìö</div>
                    <div class="milestone-time">5 hours</div>
                    <div class="milestone-label">Full biography</div>
                </div>
                <div class="milestone" id="milestone-10h">
                    <div class="milestone-icon">üéôÔ∏è</div>
                    <div class="milestone-time">10 hours</div>
                    <div class="milestone-label">Quality voice clone</div>
                </div>
                <div class="milestone" id="milestone-20h">
                    <div class="milestone-icon">üë§</div>
                    <div class="milestone-time">20 hours</div>
                    <div class="milestone-label">Premium avatar</div>
                </div>
                <div class="milestone" id="milestone-50h">
                    <div class="milestone-icon">üïäÔ∏è</div>
                    <div class="milestone-time">50 hours</div>
                    <div class="milestone-label">Complete Soul</div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="products-grid">
            <!-- Biography -->
            <div class="product-card">
                <div class="product-header">
                    <span class="product-icon">üìñ</span>
                    <div>
                        <div class="product-title">Biography</div>
                        <div class="product-status" id="bio-status-text">Not started</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill primary" id="bio-progress" style="width: 0%"></div>
                </div>
                <div class="progress-label">
                    <span id="bio-chapters">0 chapters</span>
                    <span class="status-badge locked" id="bio-badge">Locked</span>
                </div>
                <a href="/biography" class="action-btn" id="bio-btn">View Biography</a>
            </div>

            <!-- Journal -->
            <div class="product-card">
                <div class="product-header">
                    <span class="product-icon">üìî</span>
                    <div>
                        <div class="product-title">Life Journal</div>
                        <div class="product-status" id="journal-status-text">Not started</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill info" id="journal-progress" style="width: 0%"></div>
                </div>
                <div class="progress-label">
                    <span id="journal-entries">0 entries</span>
                    <span class="status-badge locked" id="journal-badge">Locked</span>
                </div>
                <a href="/journal" class="action-btn secondary" id="journal-btn">View Journal</a>
            </div>

            <!-- Voice Clone -->
            <div class="product-card">
                <div class="product-header">
                    <span class="product-icon">üéôÔ∏è</span>
                    <div>
                        <div class="product-title">Voice Clone</div>
                        <div class="product-status" id="voice-status-text">Need 2+ hours</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill warning" id="voice-progress" style="width: 0%"></div>
                </div>
                <div class="progress-label">
                    <span id="voice-quality">Basic tier</span>
                    <span class="status-badge locked" id="voice-badge">Locked</span>
                </div>
                <button class="action-btn" id="voice-generate-btn" onclick="generateVoiceClone()" disabled>üéôÔ∏è Generate
                    Voice Clone</button>
            </div>

            <!-- Avatar -->
            <div class="product-card">
                <div class="product-header">
                    <span class="product-icon">üë§</span>
                    <div>
                        <div class="product-title">Avatar</div>
                        <div class="product-status" id="avatar-status-text">Need 10+ hours</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill success" id="avatar-progress" style="width: 0%"></div>
                </div>
                <div class="progress-label">
                    <span id="avatar-tier">Not available</span>
                    <span class="status-badge locked" id="avatar-badge">Locked</span>
                </div>
                <button class="action-btn" id="avatar-generate-btn" onclick="generateAvatar()" disabled>üë§ Generate
                    Avatar</button>
            </div>

            <!-- Soul -->
            <div class="product-card">
                <div class="product-header">
                    <span class="product-icon">üïäÔ∏è</span>
                    <div>
                        <div class="product-title">The Soul</div>
                        <div class="product-status" id="soul-status-text">Need 20+ hours</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill primary" id="soul-progress" style="width: 0%"></div>
                </div>
                <div class="progress-label">
                    <span id="soul-status">Not ready</span>
                    <span class="status-badge locked" id="soul-badge">Locked</span>
                </div>
                <a href="/soul" class="action-btn" id="soul-launch-btn">üïäÔ∏è Open Soul Chat</a>
            </div>
        </div>

        <!-- Process Button -->
        <div style="text-align: center; margin: 32px 0;">
            <button class="action-btn" id="process-btn" onclick="startProcessing()" style="max-width: 300px;">
                ‚ú® Process My Stories
            </button>
            <p style="margin-top: 12px; color: var(--color-text-light); font-size: 14px;" id="process-hint">
                Generate your biography and journal from recordings
            </p>
        </div>

        <!-- Encouragement -->
        <div class="encouragement" id="encouragement">
            <h3>üí™ Keep Going!</h3>
            <p id="encouragement-text">Every story you share brings your legacy closer to completion.</p>
        </div>

        <!-- Consent Management -->
        <div class="recording-stats" style="margin-top:24px;">
            <h2 style="color:var(--color-primary); margin-bottom:16px;">üîê Consent Management</h2>
            <p style="color:var(--color-text-light); font-size:16px; margin-bottom:16px;">Control what your data is used
                for. You can change these at any time.</p>
            <div id="consent-list"></div>
        </div>

        <!-- Account Management -->
        <div class="recording-stats" style="margin-top:24px; border: 2px solid #FEE2E2;">
            <h2 style="color:#B91C1C; margin-bottom:16px;">‚ö†Ô∏è Account Management</h2>
            <p style="color:var(--color-text-light); font-size:16px; margin-bottom:16px;">Permanently delete your
                account and ALL data. This cannot be undone.</p>
            <button class="action-btn" style="background:#DC2626; max-width:300px;" onclick="deleteAccount()">üóëÔ∏è Delete
                My Account</button>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('instabio_token');

        let totalSeconds = 0;
        let processingInterval = null;

        async function loadProgress() {
            try {
                // Load user stats
                const statsRes = await fetch(`${API_URL}/user/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await statsRes.json();

                if (stats.success) {
                    totalSeconds = stats.total_duration_seconds || 0;
                    updateRecordingStats(stats);
                }

                // Load processing status
                const progressRes = await fetch(`${API_URL}/progress`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const progress = await progressRes.json();

                updateProcessingStatus(progress);

                // Load biography status
                const bioRes = await fetch(`${API_URL}/biography`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bio = await bioRes.json();

                updateBiographyStatus(bio);

                // Load journal status
                const journalRes = await fetch(`${API_URL}/journal`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const journal = await journalRes.json();

                updateJournalStatus(journal);

            } catch (err) {
                console.error('Failed to load progress:', err);
            }
        }

        function updateRecordingStats(stats) {
            const hours = stats.total_duration_seconds / 3600;
            document.getElementById('total-time').textContent = formatHours(hours);

            // Update milestones
            const milestones = [
                { id: 'milestone-1h', hours: 1 },
                { id: 'milestone-5h', hours: 5 },
                { id: 'milestone-10h', hours: 10 },
                { id: 'milestone-20h', hours: 20 },
                { id: 'milestone-50h', hours: 50 }
            ];

            let currentMilestone = null;

            milestones.forEach(m => {
                const el = document.getElementById(m.id);
                if (hours >= m.hours) {
                    el.classList.add('completed');
                    el.innerHTML += '<div class="milestone-check">‚úì</div>';
                } else if (!currentMilestone) {
                    el.classList.add('current');
                    currentMilestone = m;
                }
            });

            // Update product progress based on recording hours
            updateProductProgress(hours);

            // Update encouragement
            updateEncouragement(hours);
        }

        function updateProductProgress(hours) {
            // Voice clone progress (needs 2h for basic, 10h for good, 20h for premium)
            const voiceProgress = Math.min((hours / 20) * 100, 100);
            document.getElementById('voice-progress').style.width = `${voiceProgress}%`;

            if (hours >= 20) {
                document.getElementById('voice-quality').textContent = 'Premium tier';
                document.getElementById('voice-badge').className = 'status-badge ready';
                document.getElementById('voice-badge').textContent = 'Ready';
                document.getElementById('voice-status-text').textContent = 'Premium quality available!';
                document.getElementById('voice-generate-btn').disabled = false;
            } else if (hours >= 10) {
                document.getElementById('voice-quality').textContent = 'Good tier';
                document.getElementById('voice-badge').className = 'status-badge available';
                document.getElementById('voice-badge').textContent = 'Available';
                document.getElementById('voice-status-text').textContent = `${Math.round(20 - hours)}h more for premium`;
                document.getElementById('voice-generate-btn').disabled = false;
            } else if (hours >= 2) {
                document.getElementById('voice-quality').textContent = 'Basic tier';
                document.getElementById('voice-badge').className = 'status-badge available';
                document.getElementById('voice-badge').textContent = 'Available';
                document.getElementById('voice-status-text').textContent = `${Math.round(10 - hours)}h more for good`;
                document.getElementById('voice-generate-btn').disabled = false;
            } else {
                document.getElementById('voice-status-text').textContent = `${Math.round(2 - hours)}h more needed`;
            }

            // Avatar progress
            const avatarProgress = Math.min((hours / 20) * 100, 100);
            document.getElementById('avatar-progress').style.width = `${avatarProgress}%`;

            if (hours >= 20) {
                document.getElementById('avatar-tier').textContent = 'High-fidelity';
                document.getElementById('avatar-badge').className = 'status-badge ready';
                document.getElementById('avatar-badge').textContent = 'Ready';
                document.getElementById('avatar-status-text').textContent = 'Premium avatar available!';
                document.getElementById('avatar-generate-btn').disabled = false;
            } else if (hours >= 10) {
                document.getElementById('avatar-tier').textContent = 'Dynamic';
                document.getElementById('avatar-badge').className = 'status-badge available';
                document.getElementById('avatar-badge').textContent = 'Available';
                document.getElementById('avatar-status-text').textContent = `${Math.round(20 - hours)}h more for premium`;
                document.getElementById('avatar-generate-btn').disabled = false;
            } else {
                document.getElementById('avatar-status-text').textContent = `${Math.round(10 - hours)}h more needed`;
            }

            // Soul progress
            const soulProgress = Math.min((hours / 50) * 100, 100);
            document.getElementById('soul-progress').style.width = `${soulProgress}%`;

            if (hours >= 50) {
                document.getElementById('soul-status').textContent = 'Complete';
                document.getElementById('soul-badge').className = 'status-badge ready';
                document.getElementById('soul-badge').textContent = 'Ready';
                document.getElementById('soul-status-text').textContent = 'Your Soul is ready!';
            } else if (hours >= 20) {
                document.getElementById('soul-status').textContent = 'Growing';
                document.getElementById('soul-badge').className = 'status-badge processing';
                document.getElementById('soul-badge').textContent = 'Growing';
                document.getElementById('soul-status-text').textContent = `${Math.round(50 - hours)}h more for complete`;
            } else {
                document.getElementById('soul-status-text').textContent = `${Math.round(20 - hours)}h more needed`;
            }
        }

        function updateProcessingStatus(progress) {
            const processingCard = document.getElementById('processing-status');
            const processBtn = document.getElementById('process-btn');
            const processHint = document.getElementById('process-hint');

            if (progress.status === 'processing') {
                processingCard.classList.remove('hidden');
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';

                document.getElementById('processing-stage').textContent =
                    formatStage(progress.stage);
                document.getElementById('processing-fill').style.width =
                    `${progress.progress || 0}%`;
                document.getElementById('processing-percent').textContent =
                    `${progress.progress || 0}%`;

                // Poll for updates
                if (!processingInterval) {
                    processingInterval = setInterval(loadProgress, 3000);
                }
            } else {
                processingCard.classList.add('hidden');
                processBtn.disabled = false;
                processBtn.textContent = '‚ú® Process My Stories';

                if (processingInterval) {
                    clearInterval(processingInterval);
                    processingInterval = null;
                }

                if (progress.status === 'complete') {
                    processHint.textContent = 'Last processed: ' +
                        new Date(progress.completed_at).toLocaleDateString();
                }
            }
        }

        function updateBiographyStatus(data) {
            if (data.success && data.biography) {
                const chapters = data.biography.chapters || [];
                document.getElementById('bio-chapters').textContent =
                    `${chapters.length} chapters`;
                document.getElementById('bio-progress').style.width = '100%';
                document.getElementById('bio-badge').className = 'status-badge ready';
                document.getElementById('bio-badge').textContent = 'Ready';
                document.getElementById('bio-status-text').textContent = 'Your story is ready!';
            } else if (data.status === 'processing') {
                document.getElementById('bio-progress').style.width =
                    `${data.progress || 0}%`;
                document.getElementById('bio-badge').className = 'status-badge processing';
                document.getElementById('bio-badge').textContent = 'Processing';
                document.getElementById('bio-status-text').textContent = 'Creating your story...';
            }
        }

        function updateJournalStatus(data) {
            if (data.success && data.journal && data.journal.entries) {
                const entries = data.journal.entries.length;
                document.getElementById('journal-entries').textContent =
                    `${entries} entries`;
                document.getElementById('journal-progress').style.width = '100%';
                document.getElementById('journal-badge').className = 'status-badge ready';
                document.getElementById('journal-badge').textContent = 'Ready';
                document.getElementById('journal-status-text').textContent = 'Your journal is ready!';
            }
        }

        function updateEncouragement(hours) {
            const messages = [
                { min: 0, msg: "Start recording to build your legacy!" },
                { min: 0.5, msg: "Great start! Keep those memories flowing." },
                { min: 1, msg: "One hour down! Your sample chapter is unlocked." },
                { min: 2, msg: "Your voice is becoming familiar to us." },
                { min: 5, msg: "Amazing progress! Your full biography awaits." },
                { min: 10, msg: "Your voice clone is getting really good now!" },
                { min: 20, msg: "You're building something truly special." },
                { min: 50, msg: "You've created a complete legacy. Incredible!" }
            ];

            let message = messages[0].msg;
            for (const m of messages) {
                if (hours >= m.min) message = m.msg;
            }

            document.getElementById('encouragement-text').textContent = message;
        }

        function formatHours(hours) {
            if (hours < 1) {
                return `${Math.round(hours * 60)}m`;
            }
            return `${hours.toFixed(1)}h`;
        }

        function formatStage(stage) {
            const stages = {
                'starting': 'üöÄ Starting up...',
                'fetching_transcripts': 'üìù Reading your words...',
                'extracting_entities': 'üîç Finding people, places, and events...',
                'building_timeline': 'üìÖ Building your timeline...',
                'generating_biography': '‚úçÔ∏è Writing your story...',
                'generating_journal': 'üìî Creating journal entries...',
                'complete': '‚úÖ All done!'
            };
            return stages[stage] || stage;
        }

        async function startProcessing() {
            try {
                const btn = document.getElementById('process-btn');
                btn.disabled = true;
                btn.textContent = 'Starting...';

                const response = await fetch(`${API_URL}/process`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    loadProgress();
                } else {
                    alert(data.message || 'Failed to start processing');
                    btn.disabled = false;
                    btn.textContent = '‚ú® Process My Stories';
                }

            } catch (err) {
                console.error('Failed to start processing:', err);
                alert('Failed to start processing. Please try again.');
            }
        }

        // Initialize
        loadProgress();
        loadConsents();

        async function generateVoiceClone() {
            const btn = document.getElementById('voice-generate-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            try {
                const resp = await fetch(`${API_URL}/voice-clone/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (data.status === 'unavailable') {
                    alert('Voice clone service is not configured. Please add your ElevenLabs API key.');
                } else if (data.success) {
                    alert('üéôÔ∏è Voice clone generated successfully!');
                } else {
                    alert(data.message || 'Voice clone generation failed.');
                }
            } catch (e) {
                alert('Connection error. Please try again.');
            }
            btn.disabled = false;
            btn.textContent = 'üéôÔ∏è Generate Voice Clone';
        }

        async function generateAvatar() {
            const btn = document.getElementById('avatar-generate-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            try {
                const resp = await fetch(`${API_URL}/avatar/generate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (data.status === 'unavailable') {
                    alert('Avatar service is not configured. Please check SadTalker API.');
                } else if (data.success) {
                    alert('üë§ Avatar generated successfully!');
                } else {
                    alert(data.message || 'Avatar generation failed.');
                }
            } catch (e) {
                alert('Connection error. Please try again.');
            }
            btn.disabled = false;
            btn.textContent = 'üë§ Generate Avatar';
        }

        async function loadConsents() {
            try {
                const resp = await fetch(`${API_URL}/consents`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (!data.success) return;

                const consentList = document.getElementById('consent-list');
                const icons = ['üìù', 'üéôÔ∏è', 'üìñ', 'üé§', 'üë§', 'üïäÔ∏è'];
                const descriptions = [
                    'Account creation and terms',
                    'Audio recording and storage',
                    'Biography generation from transcripts',
                    'Voice cloning using recordings',
                    'Avatar creation from photos/video',
                    'Soul AI companion using your memories'
                ];
                let html = '';
                data.consents.forEach((c, i) => {
                    const checked = c.accepted ? 'checked' : '';
                    html += `<div style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--color-cream);">
                        <input type="checkbox" ${checked} onchange="toggleConsent(${c.tier}, this.checked)"
                            style="width:24px; height:24px; accent-color:var(--color-primary);">
                        <span style="font-size:24px;">${icons[i] || 'üìã'}</span>
                        <div>
                            <div style="font-weight:600;">${escapeHtml(c.tier_name || 'Tier ' + c.tier)}</div>
                            <div style="font-size:14px; color:var(--color-text-light);">${descriptions[i] || ''}</div>
                        </div>
                    </div>`;
                });
                consentList.innerHTML = html;
            } catch (e) { /* silent */ }
        }

        async function toggleConsent(tier, accepted) {
            try {
                await fetch(`${API_URL}/consent`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tier, accepted })
                });
            } catch (e) { /* silent */ }
        }

        async function deleteAccount() {
            const c1 = confirm('‚ö†Ô∏è Are you sure you want to delete your account?\n\nThis will permanently remove ALL your recordings, transcripts, biography, and data.');
            if (!c1) return;
            const c2 = confirm('This is your FINAL warning.\n\nType OK to confirm deletion of all data.');
            if (!c2) return;

            try {
                const resp = await fetch(`${API_URL}/account`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await resp.json();
                if (data.success) {
                    localStorage.clear();
                    alert('Your account has been permanently deleted.');
                    window.location.href = '/';
                } else {
                    alert('Deletion failed. Please try again.');
                }
            } catch (e) {
                alert('Connection error. Please try again.');
            }
        }
    </script>
</body>

</html>